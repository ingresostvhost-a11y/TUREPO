<?php
session_start();
 date_default_timezone_set("UTC"); // Base neutral - cada prospecto usa su timezone guardado
header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');
header('Pragma: no-cache');

require_once __DIR__ . '/admin/includes/db.php';

/* ====== Ventana de acceso por horario (2 minutos antes) ====== */
$emailParam    = trim(strtolower($_GET['email'] ?? ($_SESSION['prospect_email'] ?? '')));
$EARLY_WINDOW  = 120; // segundos

$tooEarly        = false;
$secondsToGo     = null;
$nombreProspect  = '';
$horarioWebinar  = null;

if ($emailParam) {
  // Usamos mysqli ($conn) seg√∫n tu include
  $stmt = $conn->prepare("SELECT nombre, horario_webinar FROM prospect WHERE email=? LIMIT 1");
  $stmt->bind_param("s", $emailParam);
  $stmt->execute();
  $stmt->bind_result($nombreProspect, $horarioWebinar);
  if ($stmt->fetch() && !empty($horarioWebinar)) {
    $start = new DateTime($horarioWebinar, new DateTimeZone('America/Puerto_Rico'));
    $now   = new DateTime('now',          new DateTimeZone('America/Puerto_Rico'));
    $secondsToGo = $start->getTimestamp() - $now->getTimestamp();

    if ($secondsToGo > $EARLY_WINDOW) {
      $tooEarly = true;
    } else {
      $_SESSION['from_schedule'] = true;
    }
  }
  $stmt->close();
}

/* ====== P√°gina de espera con countdown ====== */
if ($tooEarly) {
  $mins = max(0, floor($secondsToGo / 60));
  $secs = max(0, $secondsToGo % 60);
  ?>
  <!DOCTYPE html>
  <html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Esperando tu horario ‚Äì IngresosAI</title>
    <style>
      body{background:#0d2c54;color:#fff;font-family:Poppins,Arial,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
      .wrap{text-align:center;max-width:560px;padding:20px}
      .count{font-size:3rem;color:#ffcc00;margin:20px 0}
      .btn{background:#ffcc00;color:#0d2c54;padding:10px 20px;border-radius:10px;text-decoration:none;font-weight:700}
    </style>
  




<style id="attendeeStylesV6">
.att-badge{display:inline-flex;align-items:center;font-weight:700;margin-left:12px}
.att-badge .num{color:#e03131}
.att-hide{display:none!important}
</style>
</head>
  <body>
    <div class="wrap">
      <img src="https://ingresosai.info/robot-ingresosai.png" width="180" alt="IngresosAI">
      <h2>‚è≥ Falta poco para empezar</h2>
      <p>Tu acceso se habilitar√° <b>2 minutos antes</b> del horario reservado.</p>
      <div id="cd" class="count"><?php echo sprintf('%02d:%02d', $mins, $secs); ?></div>
      <a href="webinar-schedule.php?name=<?php echo urlencode($nombreProspect ?? ''); ?>&email=<?php echo urlencode($emailParam); ?>" class="btn">Cambiar horario</a>
    </div>
    <script>
      let remaining = <?php echo (int)$secondsToGo; ?>;
      const EARLY_WINDOW = <?php echo (int)$EARLY_WINDOW; ?>;
      const cd = document.getElementById('cd');
      function tick(){
        remaining--;
        if (remaining <= EARLY_WINDOW) { window.location.reload(); return; }
        const m = Math.floor(remaining/60), s = remaining%60;
        cd.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }
      setInterval(tick,1000);
    </script>
  <script src="/assets/js/attendees.js?v=1"></script>
<script src="/assets/js/attendees.js?v=1"></script>
<script src="/assets/js/attendees.js?v=2"></script>
<script src="/assets/js/attendees.js?v=4"></script>
</body>
  </html>
  <?php exit;
}

/* ====== Protecci√≥n de acceso ====== */
if (
  !isset($_SESSION['from_schedule']) &&
  (!isset($_GET['debug']) || $_GET['debug'] !== 'alaviles123')
) {
  echo "<!DOCTYPE html><html><body><h2 style='color:red;text-align:center'>Acceso no autorizado</h2><script src="/assets/js/attendees.js?v=4"></script>
</body></html>";
  exit;
}

// Exponemos un posible lead_id (puede ser email o id)
$leadIdForJs = $_SESSION['prospect_id'] ?? $_SESSION['prospect_email'] ?? '';
?>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Webinar Exclusivo IngresosAI ‚Äì Domina CPA con IA</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  :root{--brand:#0d2c54;--brand-2:#00b8ff;--bg:#f4f6f9;--ink:#0f172a}
  body{background:var(--bg);font-family:Poppins,Arial,sans-serif}
  .header{background:var(--brand);color:#fff;padding:14px 10px;text-align:center;border-bottom:3px solid var(--brand-2)}
  .brand-row img{width:160px;max-width:48vw;height:auto;object-fit:contain}

  .video-container{position:relative;width:100%;padding-top:56.25%;background:#000;border:3px solid var(--brand);border-radius:12px;overflow:hidden}
  video,img.thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  #unmuteBtn{position:absolute;bottom:14px;right:14px;background:rgba(0,0,0,.64);color:#fff;border:none;padding:10px 14px;border-radius:26px}

  .chat-box{background:#fff;border:1px solid #e7eaf0;border-radius:12px;padding:12px;height:480px;overflow-y:auto;}
  .msg{margin-bottom:10px}
  .bubble{background:#f5f7fb;color:var(--ink);border-radius:12px;padding:10px 12px;display:inline-block;max-width:100%}
  .msg.me .bubble{background:var(--brand);color:#fff}

  .poll-card{background:#fff;border:1px solid #ddd;border-radius:12px;margin-top:15px;padding:15px;text-align:center}
  .poll-title{font-weight:700;margin-bottom:8px;color:var(--brand)}
  .poll-options{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:8px}
  .poll-btn{background:var(--brand);color:#fff;border:none;border-radius:50px;padding:8px 14px;font-size:14px;font-weight:600;cursor:pointer}
  .poll-btn[disabled]{opacity:.6;cursor:not-allowed}
  .poll-btn:hover{opacity:.9}
  .poll-meta{font-size:12px;opacity:.7;margin-top:8px}
  .poll-result{margin-top:10px;text-align:left}
  .bar{height:10px;border-radius:6px;background:#e9eef6;overflow:hidden}
  .fill{height:10px;background:var(--brand);border-radius:6px;transition:width .35s ease}
</style>
</head>
<body>
  <div class="header">
    <div class="brand-row">
      <img src="https://ingresosai.info/robot-ingresosai.png" alt="IngresosAI" />
    </div>
    <h1 style="font-size:1.4rem;font-weight:700;margin:6px 0 0;">üé• Webinar Exclusivo <span style="color:#00b8ff;">IngresosAI</span></h1>
    <p style="font-size:.98rem;margin:2px 0 6px;color:#d1e9ff;">Domina CPA Marketing con Inteligencia Artificial</p>
  </div>

  <div class="container mt-4">
    <div class="row g-4">
      <!-- Video -->
      <div class="col-md-8">
        <div class="video-container">
          <img class="thumb" id="thumb1" src="thumbnail1.jpg" alt="Conexi√≥n al webinar" />
          <video id="webinarVideo" playsinline muted style="display:none;"></video>
          <button id="unmuteBtn" style="display:none;">üîä Activar sonido</button>
        </div>

        <!-- Polls -->
        <div id="pollContainer"></div>
      </div>

      <!-- Chat -->
      <div class="col-md-4">
        <h5>üí¨ Chat en Vivo</h5>
        <div id="chat" class="chat-box"></div>

        <div class="input-group mt-2">
          <input type="text" id="msg" class="form-control" placeholder="Escribe tu pregunta‚Ä¶" />
          <button id="sendBtn" class="btn btn-primary" onclick="sendMessage()">Enviar</button>
        </div>

        <p id="attendees" class="text-center mt-3 fw-bold" style="color:var(--brand);">
          üë• Asistentes conectados: <span id="count">190</span> ‚Äî <span id="inRoom">190 en sala</span>
        </p>
      </div>
    </div>
  </div>

<script>
// Exponemos lead_id al JS
window.LEAD_ID = <?php echo json_encode($leadIdForJs); ?>;

window.addEventListener("load", () => {
  /* ---------- VIDEO (HLS) ---------- */
  const video     = document.getElementById("webinarVideo");
  const thumb1    = document.getElementById("thumb1");
  const unmuteBtn = document.getElementById("unmuteBtn");
  const qs        = new URLSearchParams(location.search);
  const STREAM    = qs.get("stream") || "https://ingresosai.info/hls/webinar.m3u8";

  function startVideo(){
    thumb1.style.display = "none";
    video.style.display  = "block";
    unmuteBtn.style.display = "block";

    if (window.Hls && Hls.isSupported()){
      const hls = new Hls();
      hls.loadSource(STREAM);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
    } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
      video.src = STREAM; video.play().catch(()=>{});
    } else {
      video.src = STREAM; video.play().catch(()=>{});
    }
  }
  unmuteBtn.addEventListener("click", () => { video.muted=false; video.volume=1; unmuteBtn.style.display="none"; });
  setTimeout(startVideo, 800);

  /* ---------- Helpers de UI / tiempo humano ---------- */
  const chat     = document.getElementById("chat");
  const msgInput = document.getElementById("msg");
  const sendBtn  = document.getElementById("sendBtn");

  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

  function addBubble(role,name,html){
    const row = document.createElement("div");
    row.className = `msg ${role==='me'?'me':'them'}`;
    row.innerHTML = `<div class="bubble"><b>${name}:</b> ${html}</div>`;
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }
  function showTyping(){
    if (document.getElementById("typingRow")) return;
    const row=document.createElement("div");
    row.id="typingRow";
    row.className="msg them";
    row.innerHTML=`<div class="bubble"><i>Adriel est√° escribiendo‚Ä¶</i></div>`;
    chat.appendChild(row);
    chat.scrollTop=chat.scrollHeight;
  }
  function hideTyping(){
    const row=document.getElementById("typingRow");
    if(row) row.remove();
  }

  /**
   * Orquesta la respuesta "humana":
   * - Espera ~2s antes de empezar a escribir
   * - Muestra "escribiendo‚Ä¶" y mantiene un m√≠nimo de tiempo de tipeo
   * - Publica la respuesta cuando el fetch (si lo hay) termine y se cumpla el tiempo m√≠nimo
   */
  async function respondWithHumanTiming(getAnswerFn, { who='', question='', minPreDelay=2000, preJitter=600, minTyping=1800, maxTyping=3200, fallback='' } = {}){
    const preDelay = minPreDelay + Math.floor(Math.random()*preJitter);
    await wait(preDelay);         // ‚è±Ô∏è pausa inicial antes de tipear
    showTyping();
    const typingMs = minTyping + Math.floor(Math.random()*(maxTyping - minTyping));

    let payload = null;
    try{
      const fetchPromise = getAnswerFn ? getAnswerFn() : Promise.resolve(null);
      const [data] = await Promise.all([
        fetchPromise.catch(()=>null),
        wait(typingMs)            // ‚å®Ô∏è tiempo de tipeo m√≠nimo
      ]);
      payload = data;
    }catch(e){
      payload = null;
    }
    hideTyping();

    const namePart = who ? `, ${who.split(' ')[0]}` : '';
    const text = (payload && payload.text) ? payload.text :
                 (fallback || `¬°Gracias por tu comentario${namePart}! Ahora mismo ampliamos ese punto üëå`);

    addBubble('them','Adriel (Moderador)', text);
  }

  /* ---------- CHAT (usuario -> Adriel) ---------- */
  window.sendMessage = async function(){
    const q = msgInput.value.trim();
    if(!q || sendBtn.disabled) return;
    sendBtn.disabled = true;
    addBubble('me','T√∫',q);
    msgInput.value='';

    const getAnswer = async () => {
      const res = await fetch('chatResponder.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question:q })
      });
      return await res.json();
    };

    await respondWithHumanTiming(getAnswer, {
      who: 'T√∫',
      question: q,
      minPreDelay: 2000,      // ~2s antes de empezar a escribir
      preJitter: 800,         // +0‚Äì0.8s aleatorio
      minTyping: 1800,        // 1.8s m√≠nimo de tipeo
      maxTyping: 3200,
      fallback: `¬°Buena pregunta! Te lo explico: ${q}`
    });

    sendBtn.disabled=false;
    msgInput.focus();
  };
  msgInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});

  // Mensajes iniciales para no arrancar vac√≠o (sin cambios de timing)
  setTimeout(()=> addBubble('them','Adriel (Moderador)','¬°Bienvenido/a! Dime desde qu√© pa√≠s te conectas y qu√© esperas aprender hoy üôå'), 1200);
  setTimeout(()=> addBubble('them','Adriel (Moderador)','Durante el webinar voy dejando links y encuestas para ayudarte üòâ'), 3000);

  /* ---------- SIMULACI√ìN DE ASISTENTES (misma l√≥gica) ---------- */
  const countEl  = document.getElementById("count");
  const inRoomEl = document.getElementById("inRoom");
  let count = parseInt(countEl?.textContent || "190", 10) || 190;

  setInterval(() => {
    const change = Math.floor(Math.random() * 4) - 2; // -2 a +1
    count = Math.max(150, count + change);
    if (countEl)  countEl.textContent  = String(count);
    if (inRoomEl) inRoomEl.textContent = `${count} en sala`;
  }, 5000);

  /* ---------- RESPUESTA AUTOM√ÅTICA DE ADRIEL A MENSAJES DEL TIMELINE ---------- */
  function stripHtml(s){ return s.replace(/<[^>]*>/g,'').trim(); }

  function parseNameAndText(raw){
    // "<b>Adriel (Moderador):</b> texto"
    if (/^<b>\s*Adriel\s*\(Moderador\)\s*:\s*<\/b>/i.test(raw)){
      return { fromAdriel:true, name:'Adriel (Moderador)', text: raw.replace(/^<b>\s*Adriel\s*\(Moderador\)\s*:\s*<\/b>\s*/i,'') };
    }
    // "Adriel (Moderador): texto" sin <b>
    if (/^\s*Adriel\s*\(Moderador\)\s*:/i.test(stripHtml(raw))){
      return { fromAdriel:true, name:'Adriel (Moderador)', text: raw.replace(/^\s*Adriel\s*\(Moderador\)\s*:\s*/i,'') };
    }
    // "Nombre: texto"
    const m = stripHtml(raw).match(/^([^:]+):\s*(.*)$/);
    if (m) return { name:m[1].trim(), text: raw.replace(/^[^:]+:\s*/,'') };
    return { name:'Invitado', text: raw };
  }

  function scheduleAdrielIfQuestion(text, who=''){
    const q = stripHtml(text);
    if (!/[?¬ø]/.test(q)) return; // Solo responde si detecta pregunta

    const getAnswer = async () => {
      const res = await fetch('chatResponder.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question: q, from: who })
      });
      return await res.json();
    };

    // Ahora Adriel tarda ~2s en empezar a escribir + 1.8‚Äì3.2s de tipeo
    respondWithHumanTiming(getAnswer, {
      who,
      question: q,
      minPreDelay: 2000,
      preJitter: 800,
      minTyping: 1800,
      maxTyping: 3200,
      fallback: `¬°Excelente pregunta${who?`, ${who.split(' ')[0]}`:''}! Te lo explico: ${q}`
    });
  }

  // Muestra el mensaje del timeline y dispara respuesta de Adriel si aplica
  function addChatMessage(raw){
    const parsed = parseNameAndText(raw);

    if (parsed.fromAdriel){
      addBubble('them', 'Adriel (Moderador)', parsed.text);
      return;
    }

    const guestName = parsed.name || 'Invitado';
    addBubble('them', guestName, parsed.text);
    scheduleAdrielIfQuestion(parsed.text, guestName);
  }

  /* ---------- TIMELINE (60 MENSAJES, intacto) ---------- */
  const timelineMsgs = [
    // üëá Conversaciones naturales entre Adriel y asistentes
    { time: 65,  msg: "<i>Adriel est√° escribiendo...</i>" },
    { time: 67,  msg: "<b>Adriel (Moderador):</b> ¬°As√≠ es Luis! CPA es 100% real üí™ lo importante es hacerlo con estrategia." },
    { time: 97,  msg: "<i>Adriel est√° escribiendo...</i>" },
    { time: 99,  msg: "<b>Adriel (Moderador):</b> Bienvenida Sof√≠a üôå, prep√°rate, vas a entender todo paso a paso." },
    { time: 156, msg: "Pedro üáµüá∑: Qu√© bueno saberlo üî•" },
    { time: 158, msg: "<b>Adriel (Moderador):</b> Gracias Pedro üëè, Puerto Rico siempre presente üáµüá∑" },
    { time: 216, msg: "Miguel üá™üá∏: ¬°Eso tiene sentido!" },
    { time: 218, msg: "<b>Adriel (Moderador):</b> Exacto Miguel, por eso explicamos c√≥mo ganar sin depender de suerte üòé" },
    { time: 376, msg: "Patricio üá®üá±: Jajaja, ya me convencieron üòÇ" },
    { time: 378, msg: "<b>Adriel (Moderador):</b> Jajaja, me alegra Patricio ü§ù, ¬°vas a ver que es posible!" },
    { time: 456, msg: "Juan üá®üá¥: Buen dato eso de los tiempos üëå" },
    { time: 458, msg: "<b>Adriel (Moderador):</b> Correcto Juan, lo normal son 24‚Äì48 h para aprobaci√≥n üöÄ" },
    { time: 575, msg: "<i>Adriel est√° escribiendo...</i>" },
    { time: 577, msg: "<b>Adriel (Moderador):</b> Roberto, no te preocupes üôå muchos comienzan desde cero y avanzan r√°pido." },
    { time: 725, msg: "Ricardo üá®üá±: Lo anoto, me gusta esa dupla üëè" },
    { time: 727, msg: "<b>Adriel (Moderador):</b> ¬°Excelente Ricardo! ZeroPark + OddBytes = üî• resultados reales." },
    { time: 905, msg: "Teresa üá®üá±: Tiene l√≥gica eso de optimizar üí°" },
    { time: 907, msg: "<b>Adriel (Moderador):</b> Exactamente Teresa, la optimizaci√≥n es lo que separa al que gana del que gasta üòâ" },
    { time: 981, msg: "Graciela üá¶üá∑: Gracias por aclararlo üôè" },
    { time: 983, msg: "<b>Adriel (Moderador):</b> Un gusto Graciela üòä, todo lo que mostramos son datos reales de alumnos." },
    { time: 1205, msg: "<i>Adriel est√° escribiendo...</i>" },
    { time: 1207, msg: "<b>Adriel (Moderador):</b> Gracias Silvia üôè, Al lleva a√±os ense√±ando y aplicando esto a gran escala." },
    { time: 1585, msg: "Daniel üá®üá±: ¬°Eso me motiva!" },
    { time: 1587, msg: "<b>Adriel (Moderador):</b> Tal cual Daniel üí™, la constancia paga siempre." },
    { time: 1765, msg: "Luc√≠a üá©üá¥: Qu√© historia m√°s inspiradora üëè" },
    { time: 1767, msg: "<b>Adriel (Moderador):</b> Gracias Luc√≠a üòç, el caso senior fue uno de mis favoritos." },
    { time: 1885, msg: "Esteban üáµüá∑: Incre√≠ble, la IA ya lo domina todo" },
    { time: 1887, msg: "<b>Adriel (Moderador):</b> Totalmente Esteban ü§ñ, la IA es nuestra aliada para escalar campa√±as." },
    { time: 2105, msg: "Pedro üá≤üáΩ: ¬°Perfecto, espero el final entonces!" },
    { time: 2107, msg: "<b>Adriel (Moderador):</b> Claro Pedro üòé, te va a encantar la parte final donde explicamos todo el plan." },
    { time: 40, msg: "Luis üá®üá¥: ¬øEsto de CPA es real? ü§î" },
    { time: 60, msg: "Mar√≠a üá®üá±: S√≠ funciona, yo conozco casos üëè" },
    { time: 90, msg: "Pedro üáµüá∑: ¬°Saludos desde Puerto Rico!" },
    { time: 120, msg: "Sof√≠a üá¶üá∑: Primera vez en un webinar de este tema üôå" },
    { time: 150, msg: "Jos√© üá≤üáΩ: Buena introducci√≥n üëè" },
    { time: 180, msg: "Claudia üá©üá¥: Estoy aqu√≠ porque quiero independencia financiera" },
    { time: 210, msg: "Miguel üá™üá∏: CPA lo hab√≠a escuchado pero nunca entend√≠, gracias por explicar!" },
    { time: 250, msg: "Ra√∫l üá®üá∑: Qu√© bien explicado üî•" },
    { time: 280, msg: "Ana üá®üá∫: Yo soy nueva en esto y quiero aprender üôè" },
    { time: 310, msg: "Luc√≠a üá®üá±: Muy claro lo de reputaci√≥n y metas escalonadas" },
    { time: 340, msg: "Patricio üá®üá±: Suena interesante, pero ¬øser√° tan f√°cil? ü§®" },
    { time: 370, msg: "Alba üá≤üáΩ: Tengo dudas pero estoy escuchando atenta üëÇ" },
    { time: 400, msg: "Carlos üá≤üáΩ: Estoy motivado üí™" },
    { time: 450, msg: "Juan üá®üá¥: ¬øCu√°nto se tarda en aprobar una oferta? ü§î" },
    { time: 480, msg: "Marta üá™üá∏: Eso de metas escalonadas me gusta mucho üôå" },
    { time: 510, msg: "Diego üá¶üá∑: Estoy tomando notas, esto vale oro üìí" },
    { time: 540, msg: "Carmen üáµüá∑: Siempre hab√≠a querido entender bien CPA y ahora s√≠ üòç" },
    { time: 570, msg: "Roberto üá≤üáΩ: ¬øY si no tengo experiencia previa? ü§∑‚Äç‚ôÇÔ∏è" },
    { time: 600, msg: "Luc√≠a üá©üá¥: Excelente lo de Esencial y M√°xima Rentabilidad üëè" },
    { time: 640, msg: "David üá¶üá∑: ¬°Ya quiero aplicar estas campa√±as!" },
    { time: 680, msg: "Andrea üá≤üáΩ: Estoy en shock con la claridad de esto" },
    { time: 720, msg: "Ricardo üá®üá±: Tremendo lo de ZeroPark y OddBytes üöÄ" },
    { time: 760, msg: "Isabel üá∫üá∏: Esto est√° muy pro, nunca hab√≠a visto algo as√≠ en espa√±ol üëè" },
    { time: 800, msg: "Manuel üá©üá¥: La IA est√° cambiando todo ü§ñ" },
    { time: 850, msg: "Alejandro üá™üá∏: S√∫per lo del control de riesgo üí°" },
    { time: 900, msg: "Teresa üá®üá±: Eso de pausar targets malos es clave üîë" },
    { time: 940, msg: "Juan üá≤üáΩ: Me impresiona lo de los $35,000 de algunos alumnos üò±" },
    { time: 980, msg: "Graciela üá¶üá∑: ¬øDe verdad alguien gana tanto con CPA? üò¨" },
    { time: 1000, msg: "Patricia üá¶üá∑: Me da confianza ver casos de alumnos üôå" },
    { time: 1060, msg: "Diego üá®üá¥: ¬°Gracias por mostrar resultados reales!" },
    { time: 1100, msg: "Laura üá≤üáΩ: Estoy convencida üöÄ" },
    { time: 1160, msg: "Fernando üáµüá∑: Estoy listo para arrancar hoy mismo üî•" },
    { time: 1200, msg: "Silvia üá™üá∏: Gracias Al, se nota tu experiencia üôè" },
    { time: 1260, msg: "Roberto üá≤üáΩ: Estoy motivad√≠simo üí™" },
    { time: 1320, msg: "Clara üá®üá±: Me cuesta creerlo pero suena bien explicado" },
    { time: 1400, msg: "Carmen üá©üá¥: Esto de optimizaci√≥n con IA me vol√≥ la cabeza" },
    { time: 1460, msg: "Luis üá¶üá∑: Nunca hab√≠a visto algo tan organizado" },
    { time: 1520, msg: "M√≥nica üá≤üáΩ: Se nota que esto est√° probado üí°" },
    { time: 1580, msg: "Daniel üá®üá±: Estoy viendo que esto s√≠ es real" },
    { time: 1640, msg: "√Ålvaro üá™üá∏: Esto est√° brutal üöÄ" },
    { time: 1700, msg: "Julia üá®üá¥: Me encanta que hay comunidad üë•" },
    { time: 1760, msg: "Luc√≠a üá©üá¥: Incre√≠ble lo del caso senior üëè" },
    { time: 1820, msg: "Marcos üá≤üáΩ: Esto me da esperanza üôå" },
    { time: 1880, msg: "Esteban üáµüá∑: La IA es el futuro y aqu√≠ ya est√° aplicado" },
    { time: 1940, msg: "Sara üá®üá±: Estoy tomando nota üìò" },
    { time: 2000, msg: "Pablo üá™üá∏: Muy bueno lo de orquestaci√≥n IA" },
    { time: 2060, msg: "Sonia üá®üá¥: Brutal üî•" },
    { time: 2100, msg: "Pedro üá≤üáΩ: Aunque a√∫n dudo, cada vez me convence m√°s ü§î" },
    { time: 3100, msg: "<b>Adriel (Moderador):</b> Ahora comparto los planes üëá" },
    { time: 3120, msg: "üëâ <a href='https://ingresosai.com/offers/kuEqXGCV/checkout' class='offer-link' target='_blank'>Plan Esencial ‚Äì $1,500</a>" },
    { time: 3140, msg: "üëâ <a href='https://ingresosai.com/offers/AF2pfXtn/checkout' class='offer-link' target='_blank'>M√°xima Rentabilidad ‚Äì $2,500</a>" },
    { time: 3160, msg: "üëâ <a href='https://ingresosai.com/offers/M4tdE78z/checkout' class='offer-link' target='_blank'>Pack Premium + Coaching ‚Äì $5,000</a>" },
    { time: 3180, msg: "Luc√≠a üá©üá¥: ¬°Ya me inscrib√≠ al Esencial! üéâ" },
    { time: 3200, msg: "Pedro üáµüá∑: Yo voy por el de $2,500 üí™" },
    { time: 3220, msg: "Carla üá≤üáΩ: Soy alumna oficial de IngresosAI üôå" },
    { time: 3240, msg: "Jorge üá®üá¥: Estoy pidiendo un pr√©stamo pero entro s√≠ o s√≠ üôè" },
    { time: 3260, msg: "Ana üá¶üá∑: ¬°Ya entr√© al de $5,000! üî•" },
    { time: 3280, msg: "Luis üá≤üáΩ: Felicidades a todos los que se inscribieron üëè" },
    { time: 3300, msg: "Marta üá™üá∏: ¬°Estoy dentro, gracias Al! üôå" },
    { time: 3320, msg: "Sof√≠a üá®üá±: Qu√© emoci√≥n empezar hoy üöÄ" },
    { time: 3340, msg: "Diego üáµüá∑: Esto es lo mejor que he hecho üôå" },
    { time: 3360, msg: "Claudia üá®üá¥: ¬°Feliz de empezar en IngresosAI! üéâ" }
  ];
  timelineMsgs.forEach(item => setTimeout(() => { addChatMessage(item.msg); }, item.time * 1000));

  /* ---------- POLLS (clicables + resultados + persistencia local + env√≠o a backend) ---------- */
  const pollContainer = document.getElementById("pollContainer");
  const pollSchedule = [
    { time:  45000, id: "poll1", title: "¬øDesde d√≥nde nos ves?",        options: ["M√©xico/Latam","EE.UU./Canad√°","Europa","Otro"] },
    { time: 210000, id: "poll2", title: "Tu experiencia con CPA",       options: ["Cero experiencia","S√© lo b√°sico","Ya he ganado $$"] },
    { time: 540000, id: "poll3", title: "Meta de ingresos mensuales",   options: ["$500‚Äì$1,000","$1,000‚Äì$3,000","$3,000+"] }
  ];

  const LS_KEY = (id) => `poll_${id}_data`;

  function getPollData(id){
    try { return JSON.parse(localStorage.getItem(LS_KEY(id)) || 'null'); }
    catch(e){ return null; }
  }
  function savePollData(id, data){
    localStorage.setItem(LS_KEY(id), JSON.stringify(data));
  }

  function pickBaseTotals(n){
    // 20‚Äì60 cada uno (aleatorio), luego se ajustan con tu voto
    return Array.from({length:n}, () => Math.floor(20 + Math.random()*41));
  }

  async function postPollToBackend(poll_id, question, answer){
    try{
      await fetch('/admin/polls-responses.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          poll_id: poll_id,
          question: question,
          answer: answer,
          lead_id: (window.LEAD_ID || null)
        })
      });
    }catch(e){
      // Silencioso: persistencia local ya aplicada
      console.warn('No se pudo enviar el poll al backend:', e);
    }
  }

  function renderPoll(p){
    const existing = document.getElementById(p.id);
    if (existing) existing.remove();

    const card = document.createElement("div");
    card.className = "poll-card";
    card.id = p.id;

    const data = getPollData(p.id);

    if (!data || typeof data.selected !== 'number' || !Array.isArray(data.totals)) {
      // A√∫n no ha votado ‚áí mostrar opciones
      card.innerHTML = `
        <div class="poll-title">${p.title}</div>
        <div class="poll-options">
          ${p.options.map((o,i)=>`<button class="poll-btn" data-idx="${i}">${o}</button>`).join('')}
        </div>
        <div class="poll-meta">Responde para ver resultados en tiempo real</div>
      `;
      // Listeners de voto
      card.querySelectorAll(".poll-btn").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if (btn.disabled) return; // antirebote
          // Deshabilitar todos mientras procesa
          card.querySelectorAll(".poll-btn").forEach(b=>b.disabled=true);

          const idx = parseInt(btn.getAttribute("data-idx"),10);
          const base = pickBaseTotals(p.options.length);
          base[idx] += 15 + Math.floor(Math.random()*10); // ventaja a tu voto
          savePollData(p.id, { selected: idx, totals: base });

          // Enviar al backend (no bloquea UI)
          postPollToBackend(p.id, p.title, p.options[idx]);

          showResults(p, idx, base);
        });
      });
    } else {
      // Ya vot√≥ ‚áí mostrar resultados usando sus totales guardados
      showResults(p, data.selected, data.totals, card);
    }

    pollContainer.appendChild(card);
  }

  function showResults(p, myIdx, totals, cardEl){
    const sum = totals.reduce((a,b)=>a+b,0);
    const htmlResults = p.options.map((opt,i)=>{
      const pct = Math.round((totals[i]/sum)*100);
      return `
        <div style="margin:6px 0 10px">
          <div style="display:flex;justify-content:space-between;font-size:13px">
            <span>${opt}${i===myIdx ? " ‚Ä¢ Tu voto" : ""}</span>
            <span>${pct}%</span>
          </div>
          <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
        </div>
      `;
    }).join("");

    const card = cardEl || document.getElementById(p.id);
    card.innerHTML = `
      <div class="poll-title">${p.title}</div>
      <div class="poll-result">${htmlResults}</div>
      <div class="poll-meta">Total respuestas: ${sum.toLocaleString()}</div>
    `;
  }

  // Programar aparici√≥n de encuestas
  pollSchedule.forEach(p => setTimeout(()=>renderPoll(p), p.time));
});
</script>
<script src="/assets/js/attendees.js?v=4"></script>
</body>
</html>



||gis' -i "$FILE"
perl -0777 -pe 's|<script[^>]*id="attendeeCounterV3[^"]*"[^>]*>.*?</script>||gis' -i "$FILE"
perl -0777 -pe 's|<script[^>]*id="attendeeCounterV2[^"]*"[^>]*>.*?</script>||gis' -i "$FILE"
perl -0777 -pe 's|<style[^>]*id="attendeeStyles[^"]*"[^>]*>.*?</style>||gis' -i "$FILE"

# 3) CSS m√≠nimo (n√∫meros rojos, oculta duplicados)
perl -0777 -pe 's%</head>%
</head>%s' -i "$FILE"

# 4) Script persistente con MutationObserver + setInterval
cat >> "$FILE" <<'JS'


<script id="attendeeCounterV6">
(function(){
  const CAP = 150, TARGET = 120;
  let count = 34;

  const q = (sel,ctx=document)=>ctx.querySelector(sel);
  const qa = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));
  const hasTxt = (el, s) => el && (el.textContent||'').toLowerCase().includes(s.toLowerCase());

  // Encuentra el panel del chat a partir del input "Escribe tu pregunta..."
  function findChatPanel(){
    const input = q('input[placeholder*="Escribe tu pregunta"]');
    if(!input) return null;
    // Subimos hasta un contenedor que contenga el header H3 y la zona de mensajes
    let p = input.parentElement;
    for(let i=0;i<8 && p;i++){ // sube pocos niveles para no llegar a body
      if(p.querySelector('h3') && p.querySelector('input[placeholder*="Escribe tu pregunta"]')) return p;
      p = p.parentElement;
    }
    return input.closest('div');
  }

  function findHeader(panel){
    if(!panel) return null;
    // Busca un H3 que contenga "Chat en Vivo"
    const h3s = qa('h3', panel);
    let title = h3s.find(h => hasTxt(h,'chat en vivo')) || h3s[0];
    if(!title) return null;
    // Usamos el contenedor del t√≠tulo como header
    let header = title.parentElement || title;
    header.style.display = 'flex';
    header.style.alignItems = 'center';
    header.style.justifyContent = 'space-between';
    return header;
  }

  function ensureBadge(header){
    let b = q('#attendeeBadgeHeader');
    if(!b){
      b = document.createElement('span');
      b.id = 'attendeeBadgeHeader';
      b.className = 'att-badge';
      header.appendChild(b);
    }
    return b;
  }

  function fmt(n){
    return 'üë• Asistentes conectados en sala: <span class="num">'+n+
           '</span>/<span class="num">'+CAP+'</span>';
  }

  function hideFooterLine(panel){
    if(!panel) return;
    // Oculta cualquier l√≠nea que diga "Asistentes conectados:"
    qa('div,span,p,small,footer,section', panel)
      .filter(el => hasTxt(el,'asistentes conectados:'))
      .forEach(el => el.classList.add('att-hide'));
  }

  function maybeSyncFromFooter(panel){
    if(!panel) return;
    const line = qa('div,span,p,small,footer,section', panel)
      .find(el => hasTxt(el,'asistentes conectados:'));
    if(!line) return;
    const m = (line.textContent||'').match(/\d+/g);
    if(m && m[0]){
      const n = parseInt(m[0],10);
      if(!isNaN(n)) count = Math.min(Math.max(n,34), TARGET);
    }
  }

  function place(){
    const panel  = findChatPanel();
    const header = findHeader(panel);
    if(!panel || !header) return false;

    hideFooterLine(panel);
    maybeSyncFromFooter(panel);

    const badge = ensureBadge(header);
    badge.innerHTML = fmt(count);
    return true;
  }

  function tick(){
    if(count < TARGET){
      count = Math.min(TARGET, count + Math.max(1, Math.round(Math.random()*3)));
      const b = q('#attendeeBadgeHeader');
      if(b) b.innerHTML = fmt(count);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Intentos peri√≥dicos + observador del DOM
    place();
    const obs = new MutationObserver(place);
    obs.observe(document.body, {childList:true, subtree:true});
    setInterval(function(){ place(); tick(); }, 2000);
  });
})();
</script>
